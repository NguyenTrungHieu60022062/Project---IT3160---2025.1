<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Map Project - Cầu Giấy (Start / End)</title>
    <style>
      /* Bắt buộc để map hiển thị */
      html, body { height: 100%; margin: 0; padding: 0; }
      #map { height: 90vh; width: 100%; }
      #controls {
        padding: 8px;
        display: flex;
        gap: 8px;
        align-items: center;
        background: rgba(255,255,255,0.9);
        position: absolute;
        top: 8px;
        left: 8px;
        border-radius: 6px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        z-index: 5;
      }
      #info { padding: 8px; font-size: 14px; }
      button { padding: 6px 10px; cursor: pointer; }
    </style>
  </head>
  <body>
    <div id="controls">
      <button id="clearBtn">DELETE</button>
      <button id="toggleTraffic">TRAFFIC</button>
    </div>

    <div id="map"></div>
    <div id="info" style="position: absolute; bottom:8px; left:8px; background: rgba(255,255,255,0.9); border-radius:6px; padding:8px; z-index:5;">
      <div id="startInfo">Start: —</div>
      <div id="endInfo">End: —</div>
      <div id="distInfo">Khoảng cách thẳng: —</div>
    </div>

    <script>
      let map;
      let startMarker = null;
      let endMarker = null;
      let directionsService;
      let directionsRenderer;
      let trafficLayer;
      let trafficOn = false;

      function initMap() {
        const location = { lat:  21.0227, lng: 105.7918 }; // Cầu Giấy
        map = new google.maps.Map(document.getElementById("map"), {
          zoom: 15,
          center: location,
        });
        
        // Tạo lớp giao thông (Traffic Layer)
        trafficLayer = new google.maps.TrafficLayer();
        
        // Xử lý nút bật/tắt
        document.getElementById("toggleTraffic").addEventListener("click", () => {
          trafficOn = !trafficOn;
          if (trafficOn) {
            trafficLayer.setMap(map);
            document.getElementById("toggleTraffic").textContent = "Tắt Traffic";
          } else {
            trafficLayer.setMap(null);
            document.getElementById("toggleTraffic").textContent = "Bật Traffic";
          }
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true });
        directionsRenderer.setMap(map);

        map.addListener("click", (e) => {
          handleMapClick(e.latLng);
        });

        document.getElementById("clearBtn").addEventListener("click", clearAll);
      }

      function setStart(position) {
        if (startMarker) startMarker.setMap(null);
        startMarker = new google.maps.Marker({
          position,
          map,
          title: "Start Location",
          icon: 'http://maps.google.com/mapfiles/ms/icons/red-dot.png'
        });
        updateInfo();
        tryRoute();
      }

      function setEnd(position) {
        if (endMarker) endMarker.setMap(null);
        endMarker = new google.maps.Marker({
          position,
          map,
          title: "End Location",
          icon: 'http://maps.google.com/mapfiles/ms/icons/blue-dot.png'
        });
        updateInfo();
        tryRoute();
      }

      function handleMapClick(latLng) {
        if (!startMarker) {
          setStart(latLng);
        } else if (!endMarker) {
          setEnd(latLng);
        } else {
          // Nếu cả 2 đã có -> di chuyển end đến click mới (thay đổi nhanh)
          setEnd(latLng);
        }
      }

      function tryRoute() {
        directionsRenderer.set("directions", null); // xoá route cũ
        if (startMarker && endMarker) {
          // Hiển thị đường đi bằng DirectionsService (theo đường bộ)
          directionsService.route(
            {
              origin: startMarker.getPosition(),
              destination: endMarker.getPosition(),
              travelMode: google.maps.TravelMode.DRIVING, // có thể thay WALKING/BICYCLING
            },
            (result, status) => {
              if (status === "OK") {
                directionsRenderer.setDirections(result);
              } else {
                // nếu API directions fail thì vẫn giữ marker và vẽ đường thẳng
                console.warn("Directions request failed:", status);
                drawStraightLine();
              }
            }
          );

          // Đồng thời hiển thị khoảng cách thẳng (crow-fly) bằng thư viện geometry
          if (google.maps.geometry && google.maps.geometry.spherical) {
            const distMeters = google.maps.geometry.spherical.computeDistanceBetween(
              startMarker.getPosition(),
              endMarker.getPosition()
            );
            document.getElementById("distInfo").textContent = "Khoảng cách thẳng: " + distMeters.toFixed(0) + " m";
          }
        } else {
          // update khoảng cách hiển thị khi chưa đủ 2 điểm
          document.getElementById("distInfo").textContent = "Khoảng cách thẳng: —";
        }
        updateInfo();
      }

      // Vẽ đường thẳng (polyline) nếu cần
      let straightLine = null;
      function drawStraightLine() {
        if (straightLine) {
          straightLine.setMap(null);
          straightLine = null;
        }
        if (startMarker && endMarker) {
          straightLine = new google.maps.Polyline({
            path: [startMarker.getPosition(), endMarker.getPosition()],
            geodesic: true,
            strokeOpacity: 0.6,
            strokeWeight: 4,
            map: map
          });
        }
      }

      function clearAll() {
        if (startMarker) { startMarker.setMap(null); startMarker = null; }
        if (endMarker) { endMarker.setMap(null); endMarker = null; }
        if (straightLine) { straightLine.setMap(null); straightLine = null; }
        directionsRenderer.set("directions", null);
        document.getElementById("startInfo").textContent = "Start: —";
        document.getElementById("endInfo").textContent = "End: —";
        document.getElementById("distInfo").textContent = "Khoảng cách thẳng: —";
      }

      function updateInfo() {
        document.getElementById("startInfo").textContent = startMarker
          ? "Start: " + latLngToText(startMarker.getPosition())
          : "Start: —";
        document.getElementById("endInfo").textContent = endMarker
          ? "End: " + latLngToText(endMarker.getPosition())
          : "End: —";
      }

      function latLngToText(latLng) {
        return latLng.lat().toFixed(6) + ", " + latLng.lng().toFixed(6);
      }

    </script>

    <!--
      libraries=geometry để tính khoảng cách thẳng.
      callback=initMap để tự khởi tạo khi script nạp xong.
    -->
    <script async
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDTUO3uE5ySdbJUCmcbymI5RBfW-cRZCng&callback=initMap&libraries=geometry">
    </script>
  </body>
</html>
